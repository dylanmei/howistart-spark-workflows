{
  "paragraphs": [
    {
      "text": "%spark\n\nimport org.joda.time._\nimport org.joda.time.format._\nimport org.elasticsearch.spark.rdd._\nimport com.snowplowanalytics.maxmind.iplookups.IpLookups\n\ncase class Metric(timestamp: String, ip: String, port: Int, city: String, country: String, location: Array[Float], len: Int)\n\nval lines \u003d spark.sparkContext.textFile(\"/var/lib/data/tcpdump.txt\")\nval metrics \u003d lines\n  .map(_.split(\" \"))\n  .filter(_.size \u003d\u003d 8)\n  .map(attrs \u003d\u003e {\n        val timestamp \u003d new DateTime(attrs(0) + \"T\" + attrs(1), DateTimeZone.forID(\"America/Los_Angeles\"))\n        val remote \u003d attrs(5)\n        val (ip, port) \u003d remote.splitAt(remote.lastIndexOf(\".\"))\n\n        val ipl \u003d IpLookups(geoFile \u003d Some(\"/var/lib/data/geo/GeoLiteCity.dat\"))\n        \n        val (city, country, lat:Float, lon:Float) \u003d ipl.performLookups(ip)._1 match {\n            case Some(geo) \u003d\u003e (geo.city, Option(geo.countryName), geo.latitude, geo.longitude)\n            case _ \u003d\u003e (None, None, 0, 0)\n        }\n        \n        Metric(timestamp.toString(ISODateTimeFormat.dateTime()),\n            ip,\n            port.stripPrefix(\".\").stripSuffix(\":\").toInt,\n            city.getOrElse(\"\"),\n            country.getOrElse(\"\"),\n            Array(lon, lat),\n            attrs(7).toInt)\n     })\n\nEsSpark.saveToEs(metrics, \"tcpdump/metric\", Map(\"es.mapping.timestamp\" -\u003e \"timestamp\"))",
      "dateUpdated": "Aug 18, 2016 2:18:53 AM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "enabled": true,
        "editorMode": "ace/mode/scala"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1471440415262_-1417513646",
      "id": "20160817-132655_1844716700",
      "dateCreated": "Aug 17, 2016 1:26:55 PM",
      "dateStarted": "Aug 18, 2016 2:18:53 AM",
      "dateFinished": "Aug 18, 2016 2:19:13 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%elasticsearch\n\nsearch /tcpdump",
      "dateUpdated": "Aug 18, 2016 2:24:06 AM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "city",
              "index": 0.0,
              "aggr": "sum"
            },
            {
              "name": "country",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "len",
              "index": 3.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "city",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "country",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "enabled": true,
        "editorMode": "ace/mode/scala",
        "helium": {}
      },
      "settings": {
        "params": {
          "date": "",
          "size": "99",
          "limit": "25"
        },
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1471440828232_898468417",
      "id": "20160817-133348_1687074662",
      "dateCreated": "Aug 17, 2016 1:33:48 PM",
      "dateStarted": "Aug 18, 2016 2:20:03 AM",
      "dateFinished": "Aug 18, 2016 2:20:03 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%elasticsearch \n\nsize 100\nsearch /tcpdump Mountain",
      "dateUpdated": "Aug 18, 2016 1:48:18 AM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [
            {
              "name": "city",
              "index": 0.0,
              "aggr": "sum"
            }
          ],
          "values": [
            {
              "name": "country",
              "index": 1.0,
              "aggr": "sum"
            }
          ],
          "groups": [],
          "scatter": {
            "xAxis": {
              "name": "city",
              "index": 0.0,
              "aggr": "sum"
            },
            "yAxis": {
              "name": "country",
              "index": 1.0,
              "aggr": "sum"
            }
          }
        },
        "enabled": true,
        "editorMode": "ace/mode/scala"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1471484413789_-1062667441",
      "id": "20160818-014013_2121840418",
      "dateCreated": "Aug 18, 2016 1:40:13 AM",
      "dateStarted": "Aug 18, 2016 1:48:19 AM",
      "dateFinished": "Aug 18, 2016 1:48:19 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%elasticsearch\n\nsearch /tcpdump {\n    \"query\": {\n        \"filtered\": {\n            \"filter\": {\n                \"range\": {\n                    \"timestamp\": {\n                        \"gte\": \"2016-08-17T00:00:00\"\n                    }\n                }\n            }\n        }\n    }\n}",
      "dateUpdated": "Aug 18, 2016 2:19:46 AM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "enabled": true,
        "editorMode": "ace/mode/scala"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1471484386376_-2067124226",
      "id": "20160818-013946_1904810173",
      "dateCreated": "Aug 18, 2016 1:39:46 AM",
      "dateStarted": "Aug 18, 2016 2:19:46 AM",
      "dateFinished": "Aug 18, 2016 2:19:46 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sh curl -is -XDELETE http://elasticsearch:9200/tcpdump",
      "dateUpdated": "Aug 18, 2016 1:45:01 AM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "enabled": true,
        "editorMode": "ace/mode/sh"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1471441185184_-1586702994",
      "id": "20160817-133945_1388408306",
      "dateCreated": "Aug 17, 2016 1:39:45 PM",
      "dateStarted": "Aug 18, 2016 1:45:01 AM",
      "dateFinished": "Aug 18, 2016 1:45:01 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sh curl -is -XPUT http://elasticsearch:9200/tcpdump -d \u0027{\n  \"mappings\": {\n    \"metric\": {\n      \"properties\": {\n        \"location\": {\n          \"type\": \"geo_point\"\n        }\n      }\n    }\n  }\n}\u0027",
      "dateUpdated": "Aug 18, 2016 1:45:10 AM",
      "config": {
        "colWidth": 12.0,
        "graph": {
          "mode": "table",
          "height": 300.0,
          "optionOpen": false,
          "keys": [],
          "values": [],
          "groups": [],
          "scatter": {}
        },
        "enabled": true
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1471441633295_1913588136",
      "id": "20160817-134713_454116093",
      "dateCreated": "Aug 17, 2016 1:47:13 PM",
      "dateStarted": "Aug 18, 2016 1:45:10 AM",
      "dateFinished": "Aug 18, 2016 1:45:10 AM",
      "status": "FINISHED",
      "errorMessage": "",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%sh ",
      "dateUpdated": "Aug 17, 2016 2:25:21 PM",
      "config": {},
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1471443921049_671081220",
      "id": "20160817-142521_1139102373",
      "dateCreated": "Aug 17, 2016 2:25:21 PM",
      "status": "READY",
      "progressUpdateIntervalMs": 500
    }
  ],
  "name": "2. TcpDump with ElasticSearch",
  "id": "2BVZ5J3VJ",
  "lastReplName": {
    "value": "elasticsearch"
  },
  "angularObjects": {
    "2BV243892:shared_process": [],
    "2BUFW961K:shared_process": [],
    "2BW63SUXE:shared_process": [],
    "2BVHZMGGD:shared_process": [],
    "2BVGC7XJ2:shared_process": [],
    "2BVEDXHCB:shared_process": [],
    "2BV4U2ARY:shared_process": [],
    "2BVYPTTNB:shared_process": [],
    "2BVW9F1TD:shared_process": []
  },
  "config": {},
  "info": {}
}